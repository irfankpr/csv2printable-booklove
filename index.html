<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookLove CSV → HTML (2 Orders Per Page)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <!-- Upload UI -->
    <div class="text-center mt-3" id="action-div">
        <input type="file" id="csvFile" accept=".csv" class="form-control w-50 mx-auto">
        <button class="btn btn-success mt-3" onclick="handleCSV()">Upload & Render</button>
    </div>

    <!-- Output -->
    <div id="output" class="p-0 m-0 container-fluid row justify-content-center"></div>


    <script>
        function cleanDecimal(num) {
            num = Number(num);
            if (num === 0) return "0.0";
            if (num % 1 === 0) return String(num);
            return num.toFixed(3);
        }

        function handleCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return alert("Upload a CSV!");

            const reader = new FileReader();
            reader.onload = e => {
                let csv = e.target.result;
                let data = csvToJson(csv);
                renderHTML(data);
            };
            reader.readAsText(file);
        }

        function csvToJson(csv) {
            const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
            const headers = lines[0].replace("\ufeff", "").split(",");

            const data = {};
            for (let i = 1; i < lines.length; i++) {
                let parts = parseCSVLine(lines[i]);
                if (!parts.length) continue;

                let row = {};
                headers.forEach((h, idx) => row[h.trim()] = parts[idx] || "");

                const orderNo = row["Order number"];
                if (!data[orderNo]) data[orderNo] = [];
                data[orderNo].push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = "";
            let insideQuotes = false;

            for (let c of line) {
                if (c === '"') insideQuotes = !insideQuotes;
                else if (c === ',' && !insideQuotes) {
                    result.push(current);
                    current = "";
                } else current += c;
            }
            result.push(current);
            return result;
        }

        function renderHTML(json_data) {
            const box = document.getElementById("output");
            box.innerHTML = "";
            document.getElementById("action-div").style.display = "none";

            let orders = Object.entries(json_data);

            for (let i = 0; i < orders.length; i += 2) {

                const [order_no1, order1] = orders[i];
                const [order_no2, order2] = orders[i + 1] || [];

                let pageHTML = `<div class="page row p-0 m-0">`;

                pageHTML += order_no1 ? buildOrderCard(order_no1, order1) : "";
                pageHTML += order_no2 ? buildOrderCard(order_no2, order2) : "";

                pageHTML += `</div>`;
                box.innerHTML += pageHTML;
            }
        }

        function buildOrderCard(order_no, order) {

            let Tqty = 0, Tweight = 0, Tprice = 0;
            order.forEach(item => {
                Tqty += Number(item["Qty"]);
                Tweight += Number(item["Qty"]) * Number(item["Weight"]);
                Tprice += Number(item["Qty"]) * Number(item["Price"]);
            });

            const first = order[0];

            return `
        <div class="order-card col-6 border p-1 d-flex flex-column">

            <div class="order-top flex-grow-1">
                <h6 class="text-center mt-1">#${order_no}</h6>
                <p class="text-center">${first["Date created"]}, ${first["Time"]}</p>

                <table class="col-12">
                    <tr class="text-center"><th>SL</th><th>Item</th><th>Qt</th><th>Wt</th><th>Pr</th></tr>

                    ${order.map((item, idx) => `
                        <tr>
                            <td class="text-center">${idx + 1}</td>
                            <td class="">${item["Item"]}</td>
                            <td class="text-center">${item["Qty"]}</td>
                            <td class="text-center">${item["Weight"]}</td>
                            <td class="text-center">${Number(item["Price"])}</td>
                        </tr>
                    `).join("")}

                    <tr>
                        <td colspan="2" class="text-center">Total</td>
                        <td class="text-center">${Tqty}</td>
                        <td class="text-center">${cleanDecimal(Tweight)}</td>
                        <td class="text-center">${Tprice}</td>
                    </tr>
                </table>

                <p class="smaller">${first["Delivery method"]}: ₹${first["Shipping rate"] || 0}/-</p>
                <h6 class="small text-end">Total: ₹${first["Total"] || 0}/-</h6>
                <p class="small">Note: ${first["Note from customer"]}</p>
            </div>

            <div class="order-bottom mt-auto border-top p-2">
                <p class="h6">${first["Recipient name"]}</p>
                <p class="h6">${first["Delivery address"]}</p>
                <p class="h6">${first["Delivery city"]}</p>
                <p class="h6">${first["Delivery state"]}</p>
                <p class="h6">${first["Delivery zip/postal code"]}</p>
                <p class="h6">Phone: ${first["Billing phone"]}</p>
            </div>

        </div>
        `;
        }
    </script>

    <style>
/* Page background (for screen only) */
html, body {
    margin: 0;
    padding: 0;
    background-color: #c5c5c5;
}

/* Actual A4 print page */
.page {
    width: 210mm;
    height: 297mm;
    background: white;
    margin: 0 auto;
    display: flex;
    flex-direction: row;
    page-break-after: always;
}

/* Wrap text inside address / any item field */
.order-bottom p,
.order-top p,
.order-card table td {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
}

/* Order card */
.order-card {
    height: 100%;
    border: 1px dashed black !important;
}

/* Table look */
table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
    font-size: x-small !important;
}

.smaller {
    font-size: x-small !important;
}

/* PRINT MODE SETTINGS */
@media print {
    @page {
        size: A4;
        margin: 0;   /* full bleed */
    }

    html, body {
        background: white !important;
        width: auto !important;
        height: auto !important;
        overflow: visible !important;   /* allow multiple pages */
        margin: 0 !important;
        padding: 0 !important;
    }

    .page {
        width: 210mm !important;
        height: 297mm !important;
        page-break-after: always !important;
    }
}
    </style>

</body>

</html>
