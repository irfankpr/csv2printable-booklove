<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BookLove CSV → HTML (No Backend)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container-fluid p-0 m-0 justify-content-center row">

<!-- Upload UI -->
<div class="container text-center mt-3" id="action-div">
    <input type="file" id="csvFile" accept=".csv" class="form-control w-50 mx-auto">
    <button class="btn btn-success mt-3" onclick="handleCSV()">Upload & Render</button>
</div>

<!-- Output container -->
<div id="output" class="body container p-0 m-0 row justify-content-center"></div>

<script>
    function cleanDecimal(num) {
    num = Number(num);

    if (num === 0) return "0.0";              // force 0.0

    if (num % 1 === 0) return String(num);    // pure integer, no decimals

    return num.toFixed(3);                    // non-zero decimal, show 3 places
}

// ✅ Read CSV + Process like Flask
function handleCSV() {
    const file = document.getElementById('csvFile').files[0];
    if (!file) return alert("Upload a CSV!");

    const reader = new FileReader();
    reader.onload = e => {
        let csv = e.target.result;
        let data = csvToJson(csv);
        renderHTML(data);
    };
    reader.readAsText(file);
}

function csvToJson(csv) {
    const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
    
    // ✅ handle BOM
    const headers = lines[0].replace("\ufeff", "").split(",");

    const data = {};
    for (let i = 1; i < lines.length; i++) {
        let parts = parseCSVLine(lines[i]);
        if (!parts.length) continue;

        let row = {};
        headers.forEach((h, idx) => row[h.trim()] = parts[idx] || "");

        const orderNo = row["Order number"];
        if (!data[orderNo]) data[orderNo] = [];
        data[orderNo].push(row);
    }
    return data;
}

// ✅ Handles commas inside "quoted,text"
function parseCSVLine(line) {
    const result = [];
    let current = "";
    let insideQuotes = false;

    for (let c of line) {
        if (c === '"' ) insideQuotes = !insideQuotes;
        else if (c === ',' && !insideQuotes) {
            result.push(current);
            current = "";
        } else current += c;
    }
    result.push(current);
    return result;
}




// ✅ Render HTML same as Jinja template
function renderHTML(json_data) {
    const box = document.getElementById("output");
    box.innerHTML = "";

    document.getElementById("action-div").style.display = "none";

    Object.entries(json_data).forEach(([order_no, order]) => {

        let Tqty = 0, Tweight = 0, Tprice = 0;
        order.forEach(item => {
            Tqty += Number(item["Qty"]);
            Tweight += Number(item["Qty"]) * Number(item["Weight"]);
            Tprice += Number(item["Qty"]) * Number(item["Price"]);
        });

        const first = order[0];
        const cardHeight = order.length > 10 ? "297mm" : "calc(297mm / 2)";

        const html = `
        <div class="order container row p-0 m-0 border border-dark border-2" style="height:${cardHeight}">
            <div class="left container-fluid">
                <br>
                <h6 class="col-12 text-center p-1 hilite">#${order_no}</h6>
                <p class="col-12 text-center p-0 m-0">${first["Date created"]}, ${first["Time"]}</p>
                <table class="container col-12 border-1 border-secondary">
                    <tr class="text-center"><th>SL</th><th>Item</th><th>Qt</th><th>Wt</th><th>Pr</th></tr>
                    ${order.map((item, idx) => `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td class="col-10">${item["Item"]}</td>
                        <td class="text-center">${item["Qty"]}</td>
                        <td class="text-center">${item["Weight"]}</td>
                        <td class="text-center">${Number(item["Price"])}</td>
                    </tr>`).join("")}
                    <tr>
                        <td colspan="2" class="text-center">Total</td>
                        <td class="text-center">${Tqty}</td>
                        <td class="text-center">${cleanDecimal(Tweight)}</td>
                        <td class="text-center">${Tprice.toFixed(0)}</td>
                    </tr>
                </table>

                <p class="smaller">${first["Delivery method"]}: ₹${Number(first["Shipping rate"]||0)}/-</p>
                <h6 class="small text-end">Total: ₹${Number(first["Total"]||0)}/-</h6>
                <p class="small text-ellipsis">Note: ${first["Note from customer"]}</p>
            </div>

            <div class="right container-fluid p-0 m-0">
                <div class="px-5 mt-4">
                    <p class="h6">${first["Recipient name"]}</p>
                    <p class="h6">${(first["Delivery address"]||"").replace(")", ") ")}</p>
                    <p class="h6">${first["Delivery city"]}</p>
                    <p class="h6">${first["Delivery state"]}</p>
                    <p class="h6">${String(first["Delivery zip/postal code"]||"").replace(/"/g,"")}</p>
                    <p class="h6">Phone: ${String(first["Billing phone"]||"").replace(/"/g,"")}</p>
                </div>
            </div>
        </div>`;

        box.innerHTML += html;
    });
}

</script>

<style>
body{ background:rgb(180, 180, 180); }
.body{ width:210mm; background:white; margin: 0 !important; padding: 0 !important; }
.left{ width:50%; border-right:dashed 1px black;  margin: 0 !important; padding: 3 !important; }
.right{ width:50%; border-left:dashed 1px black;  margin: 0 !important; padding: 0 !important;}
table, th, td{ font-size:x-small !important; border:1px solid black; border-collapse:collapse; }
.text-ellipsis{ overflow:hidden; text-overflow:ellipsis; }
.smaller{font-size: x-small !important;}
@media print{
    @page{ size:A4 !important; margin: 0 !important; }
    .body{ width:210mm; background:white; margin: 0 !important; padding: 0 !important; }
}
</style>

</body>
</html>
